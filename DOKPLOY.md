# Инструкция по деплою через Dokploy

## Предварительные требования

1. Сервер с установленным Dokploy
2. PostgreSQL база данных (можно использовать встроенную в docker-compose или внешнюю)
3. GitHub репозиторий с кодом проекта
4. Cloudflare Tunnel для внешнего доступа (опционально)

## Шаги деплоя

### 1. Подготовка репозитория

Убедитесь, что в репозитории есть все необходимые файлы:
- `Dockerfile`
- `docker-compose.yml`
- `.dockerignore`
- `package.json`
- `prisma/schema.prisma`

### 2. Настройка Dokploy

1. Войдите в панель Dokploy
2. Создайте новый проект
3. Выберите тип деплоя: "Docker Compose" или "Dockerfile"

### 3. Настройка переменных окружения

В настройках проекта добавьте следующие переменные окружения:

```env
DATABASE_URL=postgresql://user:password@postgres:5432/nastya_site?schema=public
NEXTAUTH_URL=https://your-domain.com
NEXTAUTH_SECRET=your-secret-key-here-generate-using-openssl-rand-base64-32
NODE_ENV=production
POSTGRES_USER=postgres
POSTGRES_PASSWORD=your-secure-password
POSTGRES_DB=nastya_site
```

**Важно:** Сгенерируйте безопасный `NEXTAUTH_SECRET`:
```bash
openssl rand -base64 32
```

### 4. Настройка автоматического деплоя

1. В настройках проекта перейдите в раздел "Git"
2. Подключите ваш GitHub репозиторий
3. Выберите ветку `main` (или `master`)
4. Включите автоматический деплой при пуше в выбранную ветку

### 5. Первый деплой

1. Нажмите "Deploy" в панели Dokploy
2. Дождитесь завершения сборки и деплоя
3. Проверьте логи на наличие ошибок

### 6. Инициализация базы данных

После первого деплоя выполните миграции Prisma:

```bash
# Подключитесь к контейнеру
docker exec -it nastya-site-app sh

# Выполните миграции
npx prisma migrate deploy

# Или если используете db:push
npx prisma db push
```

### 7. Настройка Cloudflare Tunnel (опционально)

Если вы используете Cloudflare Tunnel для внешнего доступа:

1. Установите Cloudflare Tunnel на сервере
2. Создайте туннель:
```bash
cloudflared tunnel create nastya-site
```

3. Настройте маршрутизацию в Cloudflare Dashboard:
   - Public Hostname: `your-domain.com`
   - Service: `http://localhost:3000`

4. Запустите туннель:
```bash
cloudflared tunnel run nastya-site
```

### 8. Проверка работоспособности

1. Откройте ваш домен в браузере
2. Проверьте публичный лендинг
3. Попробуйте зарегистрироваться и войти
4. Проверьте работу личных кабинетов

## Обновление приложения

При каждом пуше в ветку `main` Dokploy автоматически:
1. Получит последние изменения из GitHub
2. Пересоберет Docker образ
3. Перезапустит контейнеры

## Резервное копирование

Рекомендуется настроить регулярное резервное копирование:

1. **База данных:**
```bash
docker exec nastya-site-db pg_dump -U postgres nastya_site > backup.sql
```

2. **Загруженные файлы:**
```bash
tar -czf uploads-backup.tar.gz uploads/
```

## Мониторинг

- Проверяйте логи в панели Dokploy
- Настройте мониторинг доступности через Uptime Robot или аналогичный сервис
- Настройте алерты на ошибки в логах

## Устранение неполадок

### Проблема: Приложение не запускается

1. Проверьте логи: `docker logs nastya-site-app`
2. Убедитесь, что все переменные окружения установлены
3. Проверьте подключение к базе данных

### Проблема: Ошибки миграций Prisma

1. Убедитесь, что база данных доступна
2. Проверьте `DATABASE_URL` в переменных окружения
3. Выполните миграции вручную через контейнер

### Проблема: Файлы не загружаются

1. Проверьте права доступа к папке `uploads`
2. Убедитесь, что volume смонтирован правильно в docker-compose.yml
3. Проверьте логи на наличие ошибок записи файлов

## Дополнительные настройки

### Оптимизация производительности

1. Настройте кэширование в Next.js
2. Используйте CDN для статических файлов
3. Настройте rate limiting для API роутов

### Безопасность

1. Используйте HTTPS (через Cloudflare или Let's Encrypt)
2. Регулярно обновляйте зависимости
3. Настройте firewall на сервере
4. Используйте сильные пароли для базы данных

## Поддержка

При возникновении проблем проверьте:
- Логи Dokploy
- Логи Docker контейнеров
- Документацию Next.js
- Документацию Prisma

