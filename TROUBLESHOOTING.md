# Руководство по устранению неполадок

## Ошибка 502 Bad Gateway

Если вы видите ошибку 502 Bad Gateway от Cloudflare, это означает, что Cloudflare не может подключиться к вашему приложению.

### Шаг 1: Проверьте статус приложения в Dokploy

1. Откройте панель Dokploy
2. Найдите ваш проект `nastya-site`
3. Проверьте статус контейнера - он должен быть в состоянии "Running"
4. Если контейнер не запущен:
   - Проверьте логи в разделе "Logs"
   - Попробуйте перезапустить контейнер (кнопка "Restart")

### Шаг 2: Проверьте логи приложения

В Dokploy откройте логи и проверьте наличие ошибок:

```bash
# Если у вас есть доступ к серверу через SSH:
docker logs nastya-site-app
# или
docker logs -f nastya-site-app  # для отслеживания в реальном времени
```

**Что искать в логах:**
- ✅ `Ready - started server on 0.0.0.0:8000` - приложение запущено правильно
- ❌ Ошибки с `EADDRINUSE` - порт уже занят
- ❌ Ошибки с `Cannot find module` - проблема с зависимостями
- ❌ Ошибки сборки - проблема с Next.js build

### Шаг 3: Проверьте доступность порта

На сервере выполните:

```bash
# Проверьте, слушает ли приложение на порту 8000
netstat -tlnp | grep 8000
# или
ss -tlnp | grep 8000

# Должно быть что-то вроде:
# tcp  0  0  0.0.0.0:8000  0.0.0.0:*  LISTEN  12345/node
```

### Шаг 4: Проверьте локальную доступность приложения

На сервере попробуйте обратиться к приложению напрямую:

```bash
# Проверка через curl
curl http://localhost:8000

# Должен вернуться HTML код страницы, а не ошибку подключения
```

Если `curl` не работает, значит приложение не запущено или не слушает на порту 8000.

### Шаг 5: Проверьте настройки Cloudflare Tunnel

Если используете Cloudflare Tunnel, убедитесь что:

1. **Tunnel запущен:**
   ```bash
   cloudflared tunnel list
   ```

2. **Конфигурация Tunnel правильная:**
   В файле конфигурации должен быть правильный путь:
   ```yaml
   ingress:
     - hostname: tutor.interios-miko.ru
       service: http://localhost:8000
   ```

3. **Tunnel подключен:**
   ```bash
   cloudflared tunnel run <tunnel-name>
   ```

### Шаг 6: Пересоберите и перезапустите

Если ничего не помогло:

1. В Dokploy:
   - Нажмите "Rebuild" для пересборки образа
   - Дождитесь завершения сборки
   - Нажмите "Restart" для перезапуска

2. Или через SSH:
   ```bash
   cd /path/to/project
   docker-compose down
   docker-compose up -d --build
   ```

### Шаг 7: Проверьте переменные окружения

Убедитесь, что в Dokploy заданы правильные переменные окружения:
- `NODE_ENV=production`
- `PORT=8000` (опционально, по умолчанию уже 8000)

## Типичные проблемы и решения

### Проблема: Контейнер постоянно перезапускается

**Причина:** Приложение падает при запуске

**Решение:**
1. Проверьте логи: `docker logs nastya-site-app`
2. Проверьте, что все файлы скопированы (особенно `.next/standalone` и `.next/static`)
3. Убедитесь, что сборка прошла успешно

### Проблема: Порт уже занят

**Причина:** Другое приложение использует порт 8000

**Решение:**
1. Найдите процесс, использующий порт: `lsof -i :8000` или `netstat -tlnp | grep 8000`
2. Остановите его или измените порт в `docker-compose.yml`

### Проблема: Приложение запускается, но Cloudflare не подключается

**Причина:** Неправильная настройка Cloudflare Tunnel

**Решение:**
1. Проверьте, что Tunnel указывает на `http://localhost:8000`
2. Убедитесь, что Tunnel запущен
3. Проверьте логи Tunnel: `cloudflared tunnel info <tunnel-name>`

### Проблема: ChunkLoadError после деплоя

**Решение:** Это нормально после нового деплоя. Обработчик ошибок автоматически перезагрузит страницу. Пользователям нужно просто обновить страницу в браузере.

## Контакты для поддержки

Если проблема не решается:
1. Соберите логи: `docker logs nastya-site-app > logs.txt`
2. Проверьте конфигурацию Cloudflare Tunnel
3. Убедитесь, что сервер имеет доступ в интернет


