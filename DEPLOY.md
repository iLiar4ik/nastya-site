# Инструкция по деплою в Dokploy

## Подготовка к деплою

### 1. Настройка переменных окружения

Создайте файл `.env.production` или настройте переменные в Dokploy:

```env
# Database
DB_HOST=postgres
DB_PORT=5432
DB_NAME=nastya_tutor
DB_USER=postgres
DB_PASSWORD=your_secure_password

# JWT
JWT_SECRET=your-very-secure-secret-key-minimum-32-characters-long
JWT_EXPIRES_IN=24h
JWT_REFRESH_EXPIRES_IN=7d

# Server
NODE_ENV=production
PORT=3000

# CORS (замените на ваш домен фронтенда)
CORS_ORIGIN=https://your-frontend-domain.com
```

### 2. Деплой бэкенда в Dokploy

1. **Создайте новый проект в Dokploy**
   - Название: `nastya-backend`
   - Тип: Docker

2. **Настройте Git репозиторий**
   - Подключите ваш репозиторий
   - Branch: `main` (или ваша основная ветка)
   - Build Context: `backend`
   - Dockerfile Path: `backend/Dockerfile`

3. **Настройте переменные окружения**
   - Добавьте все переменные из `.env.production`
   - **Важно**: Используйте сильный `JWT_SECRET` (минимум 32 символа)

4. **Настройте порты**
   - Container Port: `3000`
   - Public Port: `3000` (или любой другой доступный)

5. **Настройте базу данных**
   
   **Вариант A: PostgreSQL в Dokploy**
   - Создайте новый сервис PostgreSQL в Dokploy
   - Используйте имя сервиса как `DB_HOST` (например, `postgres`)
   - Настройте переменные окружения для подключения

   **Вариант B: Внешняя база данных**
   - Используйте внешний PostgreSQL (Supabase, Railway, и т.д.)
   - Укажите полный хост в `DB_HOST`

6. **Настройте команду запуска**
   - Command: `npm run start:migrate` (выполнит миграции перед запуском)

### 3. Деплой фронтенда

**Вариант A: Статический хостинг (рекомендуется)**

1. Используйте Netlify, Vercel или другой статический хостинг
2. Загрузите папку с HTML/CSS/JS файлами
3. Настройте переменную окружения `API_BASE_URL` или обновите `js/api/client.js`

**Вариант B: Nginx в Dokploy**

1. Создайте новый проект в Dokploy
2. Настройте:
   - Build Context: `.` (корень проекта)
   - Dockerfile Path: `nginx/Dockerfile`
   - Port: `80`

### 4. Настройка CORS

Убедитесь, что `CORS_ORIGIN` в переменных окружения бэкенда указывает на домен вашего фронтенда:

```
CORS_ORIGIN=https://your-frontend-domain.com
```

### 5. Настройка API клиента на фронтенде

Если фронтенд и бэкенд на разных доменах, обновите `js/api/client.js`:

```javascript
// В начале файла добавьте:
window.API_BASE_URL = 'https://your-backend-domain.com/api';
```

Или установите переменную окружения при сборке.

## Проверка после деплоя

1. **Проверьте health check:**
   ```
   curl https://your-backend-domain.com/health
   ```

2. **Проверьте API:**
   ```bash
   curl https://your-backend-domain.com/api/auth/me
   ```

3. **Проверьте логи:**
   - В Dokploy откройте логи контейнера
   - Убедитесь, что миграции выполнились успешно
   - Проверьте подключение к БД

4. **Проверьте фронтенд:**
   - Откройте в браузере
   - Попробуйте войти в систему
   - Проверьте работу API запросов в консоли браузера

## Локальное тестирование с Docker

Перед деплоем можно протестировать локально:

```bash
# Запуск с docker-compose
docker-compose up -d

# Проверка логов
docker-compose logs -f backend

# Остановка
docker-compose down
```

## Резервное копирование

Настройте автоматическое резервное копирование базы данных:

```bash
# Пример скрипта бэкапа
pg_dump -h $DB_HOST -U $DB_USER -d $DB_NAME > backup_$(date +%Y%m%d).sql
```

## Мониторинг

Рекомендуется настроить:
- Логирование ошибок
- Мониторинг производительности
- Алерты при падении сервиса
- Мониторинг использования ресурсов

## Обновление

Для обновления приложения:
1. Закоммитьте изменения в Git
2. Dokploy автоматически обнаружит изменения
3. Пересоберет и перезапустит контейнер
4. Миграции выполнятся автоматически при старте

## Troubleshooting

### Проблема: Бэкенд не подключается к БД
- Проверьте переменные окружения `DB_*`
- Убедитесь, что БД доступна из контейнера
- Проверьте логи: `docker-compose logs backend`

### Проблема: CORS ошибки
- Проверьте `CORS_ORIGIN` в переменных окружения
- Убедитесь, что домен фронтенда указан правильно

### Проблема: Миграции не выполняются
- Проверьте логи при старте
- Убедитесь, что команда `start:migrate` используется
- Проверьте права доступа к БД

### Проблема: Токены не работают
- Проверьте `JWT_SECRET` (должен быть одинаковым для всех инстансов)
- Убедитесь, что токены сохраняются в localStorage

