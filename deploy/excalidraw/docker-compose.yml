# Excalidraw: фронтенд + сервер комнат + хранилище (Redis).
# Поддержка своих комнат и синхронизации из коробки.
# Переменные EXCALIDRAW_* задайте в Dokploy → Environment (или в .env рядом с файлом).
# Порты не публикуем на хост — Dokploy маршрутизирует по доменам через свою сеть (порт 80 на сервере уже занят основным сайтом).
#
# Почему kiliandeca/excalidraw, а не официальный excalidraw/excalidraw:
# Официальный образ не даёт подменить URL коллаборации и storage — они зашиты при сборке. Форк kiliandeca
# генерирует env.json из переменных окружения при старте (SOCKET_SERVER_URL, HTTP_STORAGE_BACKEND_URL и т.д.),
# поэтому его можно использовать со своим excalidraw-room и storage. Минус — образ на Docker Hub редко обновляется.
#
# Вариант с актуальным UI: сборка из официального репозитория — см. Dockerfile.official и
# docker-compose.official.yml (полный стек в одном файле). В Dokploy укажите путь к compose:
# deploy/excalidraw/docker-compose.official.yml. URL room и storage задаются при сборке через build-args.
#
# Важно: образ собирается из Dockerfile.patch — в нём вшит entrypoint (entrypoint-patch.sh),
# который при каждом старте подменяет URL комнат, заглушку sw.js и создаёт env.json.
# Так патч не зависит от command в compose (Dokploy и др. могут его переопределять).

services:
  excalidraw:
    build:
      context: .
      dockerfile: Dockerfile.patch
    image: nastya-excalidraw-patch
    container_name: excalidraw-frontend
    restart: unless-stopped
    environment:
      SOCKET_SERVER_URL: ${EXCALIDRAW_ROOM_WS_URL:-wss://excalidraw-room.math-nastya.ru}
      STORAGE_BACKEND: "http"
      HTTP_STORAGE_BACKEND_URL: ${EXCALIDRAW_STORAGE_URL:-https://excalidraw-api.math-nastya.ru}/api/v2
      BACKEND_V2_GET_URL: ${EXCALIDRAW_STORAGE_URL:-https://excalidraw-api.math-nastya.ru}/api/v2/scenes/
      BACKEND_V2_POST_URL: ${EXCALIDRAW_STORAGE_URL:-https://excalidraw-api.math-nastya.ru}/api/v2/scenes/
      LIBRARY_URL: https://libraries.excalidraw.com
      LIBRARY_BACKEND: https://us-central1-excalidraw-room-persistence.cloudfunctions.net/libraries
      EXCALIDRAW_ROOM_WS_URL: ${EXCALIDRAW_ROOM_WS_URL:-wss://excalidraw-room.math-nastya.ru}

  excalidraw-room-backend:
    image: excalidraw/excalidraw-room:latest
    container_name: excalidraw-room-backend
    restart: unless-stopped

  excalidraw-room:
    image: nginx:alpine
    container_name: excalidraw-room-proxy
    restart: unless-stopped
    volumes:
      - ./excalidraw-room-proxy.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - excalidraw-room-backend

  excalidraw-storage-backend:
    image: kiliandeca/excalidraw-storage-backend:latest
    container_name: excalidraw-storage
    restart: unless-stopped
    environment:
      STORAGE_URI: redis://redis:6379
      PORT: "8080"
      GLOBAL_PREFIX: /api/v2

  redis:
    image: redis:7-alpine
    container_name: excalidraw-redis
    restart: unless-stopped
