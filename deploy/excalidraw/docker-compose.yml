# Excalidraw: фронтенд + сервер комнат + хранилище (Redis).
# Поддержка своих комнат и синхронизации из коробки.
# Переменные EXCALIDRAW_* задайте в Dokploy → Environment (или в .env рядом с файлом).
# Порты не публикуем на хост — Dokploy маршрутизирует по доменам через свою сеть (порт 80 на сервере уже занят основным сайтом).
#
# Почему kiliandeca/excalidraw, а не официальный excalidraw/excalidraw:
# Официальный образ не даёт подменить URL коллаборации и storage — они зашиты при сборке. Форк kiliandeca
# генерирует env.json из переменных окружения при старте (SOCKET_SERVER_URL, HTTP_STORAGE_BACKEND_URL и т.д.),
# поэтому его можно использовать со своим excalidraw-room и storage. Минус — образ на Docker Hub редко обновляется.
#
# Вариант с актуальным UI: сборка из официального репозитория — см. Dockerfile.official и
# docker-compose.official.yml (полный стек в одном файле). В Dokploy укажите путь к compose:
# deploy/excalidraw/docker-compose.official.yml. URL room и storage задаются при сборке через build-args.
#
# Важно: во многих образах Excalidraw URL коллаборации (oss-collab.excalidraw.com) зашит в JS на этапе сборки.
# Поэтому перед запуском nginx выполняем замену в собранных файлах. Явно задаём entrypoint образа и свой command:
# иначе в части окружений (например Dokploy) CMD из compose может не применяться, и наш патч не выполняется.
# Кроме того, подменяем service-worker.js на заглушку (unregister), чтобы подмена URL доходила до браузера.

services:
  excalidraw:
    image: kiliandeca/excalidraw:latest
    container_name: excalidraw-frontend
    restart: unless-stopped
    entrypoint: ["/docker-entrypoint.sh"]
    command:
      - /bin/sh
      - -c
      - |
        set -e
        WS_URL="$${EXCALIDRAW_ROOM_WS_URL:-wss://excalidraw-room.math-nastya.ru}"
        echo "Replacing collaboration URL in JS with: $$WS_URL"
        N=0
        for dir in /usr/share/nginx/html /app /var/www/html /app/build; do
          if [ -d "$$dir" ]; then
            echo "Checking $$dir..."
            for f in $$(find "$$dir" -type f -name "*.js" 2>/dev/null); do
              if grep -q "oss-collab\.excalidraw\.com" "$$f" 2>/dev/null; then
                sed -i "s|https://oss-collab\.excalidraw\.com|$$WS_URL|g; s|wss://oss-collab\.excalidraw\.com|$$WS_URL|g" "$$f"
                N=$$(($$N + 1))
              fi
            done
            if [ -f "$$dir/env.json" ]; then
              sed -i "s|\"SOCKET_SERVER_URL\":\"[^\"]*\"|\"SOCKET_SERVER_URL\":\"$$WS_URL\"|g" "$$dir/env.json"
            fi
          fi
        done
        if [ $$N -eq 0 ]; then
          echo "WARNING: no JS files contained oss-collab in standard dirs. Trying /usr and /app..."
          for f in $$(find /usr /app -type f -name "*.js" ! -path "*/node_modules/*" 2>/dev/null); do
            if grep -q "oss-collab\.excalidraw\.com" "$$f" 2>/dev/null; then
              sed -i "s|https://oss-collab\.excalidraw\.com|$$WS_URL|g; s|wss://oss-collab\.excalidraw\.com|$$WS_URL|g" "$$f"
              N=$$(($$N + 1))
              echo "Patched: $$f"
            fi
          done
        fi
        SW_STUB='self.addEventListener("install",()=>self.skipWaiting());self.addEventListener("activate",()=>{self.registration.unregister().then(()=>self.clients.claim());});'
        for dir in /usr/share/nginx/html /app /var/www/html /app/build; do
          for name in service-worker.js sw.js; do
            if [ -f "$$dir/$$name" ]; then
              echo "Disabling Service Worker (stub): $$dir/$$name"
              printf '%s' "$$SW_STUB" > "$$dir/$$name"
            fi
          done
        done
        for f in $$(find /usr/share/nginx/html /app -type f \( -name "service-worker.js" -o -name "sw.js" \) 2>/dev/null); do
          echo "Overwriting SW: $$f"
          printf '%s' "$$SW_STUB" > "$$f"
        done
        if [ -d /usr/share/nginx/html ]; then
          echo "Force stub to nginx root: service-worker.js and sw.js"
          printf '%s' "$$SW_STUB" > /usr/share/nginx/html/service-worker.js
          printf '%s' "$$SW_STUB" > /usr/share/nginx/html/sw.js
        fi
        echo "Creating env.json with SOCKET_SERVER_URL=$$WS_URL"
        printf '%s' "{\"SOCKET_SERVER_URL\":\"$$WS_URL\"}" > /usr/share/nginx/html/env.json
        if [ -d /etc/nginx/conf.d ]; then
          echo "Disabling cache for service-worker.js and sw.js so browser gets our stub"
          printf '    location = /service-worker.js {\n      add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0";\n      add_header Pragma "no-cache";\n    }\n    location = /sw.js {\n      add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0";\n      add_header Pragma "no-cache";\n    }\n' > /tmp/sw-nocache.conf
          if [ -f /etc/nginx/conf.d/default.conf ]; then
            sed -i '/^[[:space:]]*server[[:space:]]*{/r /tmp/sw-nocache.conf' /etc/nginx/conf.d/default.conf
          fi
        fi
        echo "Patched $$N JS file(s). Starting nginx..."
        exec nginx -g 'daemon off;'
    environment:
      SOCKET_SERVER_URL: ${EXCALIDRAW_ROOM_WS_URL:-wss://excalidraw-room.math-nastya.ru}
      STORAGE_BACKEND: "http"
      HTTP_STORAGE_BACKEND_URL: ${EXCALIDRAW_STORAGE_URL:-https://excalidraw-api.math-nastya.ru}/api/v2
      BACKEND_V2_GET_URL: ${EXCALIDRAW_STORAGE_URL:-https://excalidraw-api.math-nastya.ru}/api/v2/scenes/
      BACKEND_V2_POST_URL: ${EXCALIDRAW_STORAGE_URL:-https://excalidraw-api.math-nastya.ru}/api/v2/scenes/
      LIBRARY_URL: https://libraries.excalidraw.com
      LIBRARY_BACKEND: https://us-central1-excalidraw-room-persistence.cloudfunctions.net/libraries
      EXCALIDRAW_ROOM_WS_URL: ${EXCALIDRAW_ROOM_WS_URL:-wss://excalidraw-room.math-nastya.ru}

  excalidraw-room-backend:
    image: excalidraw/excalidraw-room:latest
    container_name: excalidraw-room-backend
    restart: unless-stopped

  excalidraw-room:
    image: nginx:alpine
    container_name: excalidraw-room-proxy
    restart: unless-stopped
    volumes:
      - ./excalidraw-room-proxy.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - excalidraw-room-backend

  excalidraw-storage-backend:
    image: kiliandeca/excalidraw-storage-backend:latest
    container_name: excalidraw-storage
    restart: unless-stopped
    environment:
      STORAGE_URI: redis://redis:6379
      PORT: "8080"
      GLOBAL_PREFIX: /api/v2

  redis:
    image: redis:7-alpine
    container_name: excalidraw-redis
    restart: unless-stopped
