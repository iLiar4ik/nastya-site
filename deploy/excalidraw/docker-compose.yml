version: '3.8'

services:
  excalidraw:
    build:
      context: .
      dockerfile: Dockerfile.official
      args:
        VITE_WS_SERVER_URL: ${EXCALIDRAW_ROOM_WS_URL:-wss://excalidraw-room.math-nastya.ru}
        VITE_STORAGE_BACKEND_URL: ${EXCALIDRAW_STORAGE_URL:-https://excalidraw-api.math-nastya.ru}/api/v2
    image: excalidraw-frontend:official
    container_name: excalidraw-frontend
    restart: unless-stopped
    environment:
      - STORAGE_BACKEND=http
      - HTTP_STORAGE_BACKEND_URL=${EXCALIDRAW_STORAGE_URL:-https://excalidraw-api.math-nastya.ru}/api/v2
    labels:
      - traefik.docker.network=dokploy-network
      - traefik.http.routers.nastyamath-excalidraw-tvbhtw-20-web.rule=Host(`excalidraw.math-nastya.ru`)
      - traefik.http.routers.nastyamath-excalidraw-tvbhtw-20-web.entrypoints=web
      - traefik.http.services.nastyamath-excalidraw-tvbhtw-20-web.loadbalancer.server.port=80
      - traefik.http.routers.nastyamath-excalidraw-tvbhtw-20-web.service=nastyamath-excalidraw-tvbhtw-20-web
      - traefik.http.routers.nastyamath-excalidraw-tvbhtw-20-web.middlewares=redirect-to-https@file
      - traefik.http.routers.nastyamath-excalidraw-tvbhtw-20-websecure.rule=Host(`excalidraw.math-nastya.ru`)
      - traefik.http.routers.nastyamath-excalidraw-tvbhtw-20-websecure.entrypoints=websecure
      - traefik.http.services.nastyamath-excalidraw-tvbhtw-20-websecure.loadbalancer.server.port=80
      - traefik.http.routers.nastyamath-excalidraw-tvbhtw-20-websecure.service=nastyamath-excalidraw-tvbhtw-20-websecure
      - traefik.http.routers.nastyamath-excalidraw-tvbhtw-20-websecure.tls.certresolver=letsencrypt
      - traefik.enable=true
    networks:
      - dokploy-network
      - default
    depends_on:
      - excalidraw-room-backend
      - excalidraw-storage-backend

  excalidraw-room-backend:
    image: excalidraw/excalidraw-room:latest
    container_name: excalidraw-room-backend
    restart: unless-stopped
    environment:
      - PORT=80
      - CORS_ORIGIN=https://excalidraw.math-nastya.ru,http://localhost:3000
    expose:
      - "80"
    networks:
      - default
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3

  excalidraw-room:
    image: nginx:alpine
    container_name: excalidraw-room-proxy
    restart: unless-stopped
    volumes:
      - ./excalidraw-room-proxy.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      excalidraw-room-backend:
        condition: service_healthy
    labels:
      - traefik.docker.network=dokploy-network
      - traefik.http.routers.nastyamath-excalidraw-tvbhtw-21-web.rule=Host(`excalidraw-room.math-nastya.ru`)
      - traefik.http.routers.nastyamath-excalidraw-tvbhtw-21-web.entrypoints=web
      - traefik.http.services.nastyamath-excalidraw-tvbhtw-21-web.loadbalancer.server.port=80
      - traefik.http.routers.nastyamath-excalidraw-tvbhtw-21-web.service=nastyamath-excalidraw-tvbhtw-21-web
      - traefik.http.routers.nastyamath-excalidraw-tvbhtw-21-web.middlewares=redirect-to-https@file
      - traefik.http.routers.nastyamath-excalidraw-tvbhtw-21-websecure.rule=Host(`excalidraw-room.math-nastya.ru`)
      - traefik.http.routers.nastyamath-excalidraw-tvbhtw-21-websecure.entrypoints=websecure
      - traefik.http.services.nastyamath-excalidraw-tvbhtw-21-websecure.loadbalancer.server.port=80
      - traefik.http.routers.nastyamath-excalidraw-tvbhtw-21-websecure.service=nastyamath-excalidraw-tvbhtw-21-websecure
      - traefik.http.routers.nastyamath-excalidraw-tvbhtw-21-websecure.tls.certresolver=letsencrypt
      - traefik.enable=true
    networks:
      - dokploy-network
      - default

  excalidraw-storage-backend:
    image: kiliandeca/excalidraw-storage-backend:latest
    container_name: excalidraw-storage
    restart: unless-stopped
    environment:
      STORAGE_URI: redis://redis:6379
      PORT: "8080"
      GLOBAL_PREFIX: /api/v2
    volumes:
      - redis_data:/data
    labels:
      - traefik.docker.network=dokploy-network
      - traefik.http.routers.nastyamath-excalidraw-tvbhtw-22-web.rule=Host(`excalidraw-api.math-nastya.ru`)
      - traefik.http.routers.nastyamath-excalidraw-tvbhtw-22-web.entrypoints=web
      - traefik.http.services.nastyamath-excalidraw-tvbhtw-22-web.loadbalancer.server.port=8080
      - traefik.http.routers.nastyamath-excalidraw-tvbhtw-22-web.service=nastyamath-excalidraw-tvbhtw-22-web
      - traefik.http.routers.nastyamath-excalidraw-tvbhtw-22-web.middlewares=redirect-to-https@file
      - traefik.http.routers.nastyamath-excalidraw-tvbhtw-22-websecure.rule=Host(`excalidraw-api.math-nastya.ru`)
      - traefik.http.routers.nastyamath-excalidraw-tvbhtw-22-websecure.entrypoints=websecure
      - traefik.http.services.nastyamath-excalidraw-tvbhtw-22-websecure.loadbalancer.server.port=8080
      - traefik.http.routers.nastyamath-excalidraw-tvbhtw-22-websecure.service=nastyamath-excalidraw-tvbhtw-22-websecure
      - traefik.http.routers.nastyamath-excalidraw-tvbhtw-22-websecure.tls.certresolver=letsencrypt
      - traefik.enable=true
    networks:
      - dokploy-network
      - default
    depends_on:
      - redis

  redis:
    image: redis:7-alpine
    container_name: excalidraw-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - default
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  redis_data:
    driver: local

networks:
  dokploy-network:
    external: true
  default:
    driver: bridge
