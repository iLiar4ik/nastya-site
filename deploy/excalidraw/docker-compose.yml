# Excalidraw: фронтенд + сервер комнат + хранилище (Redis).
# Поддержка своих комнат и синхронизации из коробки.
# Переменные EXCALIDRAW_* задайте в Dokploy → Environment (или в .env рядом с файлом).
# Порты не публикуем на хост — Dokploy маршрутизирует по доменам через свою сеть (порт 80 на сервере уже занят основным сайтом).
#
# Важно: во многих образах Excalidraw URL коллаборации (oss-collab.excalidraw.com) зашит в JS на этапе сборки.
# Поэтому в command перед запуском nginx выполняем замену в собранных файлах. Entrypoint образа не переопределяем —
# он генерирует env.json и задаёт конфигурацию nginx (иначе возможна 404).

services:
  excalidraw:
    image: kiliandeca/excalidraw:latest
    container_name: excalidraw-frontend
    restart: unless-stopped
    command:
      - /bin/sh
      - -c
      - |
        set -e
        WS_URL="$${EXCALIDRAW_ROOM_WS_URL:-wss://excalidraw-room.math-nastya.ru}"
        echo "Replacing collaboration URL in JS with: $$WS_URL"
        N=0
        for dir in /usr/share/nginx/html /app /var/www/html /app/build; do
          if [ -d "$$dir" ]; then
            echo "Checking $$dir..."
            for f in $$(find "$$dir" -type f -name "*.js" 2>/dev/null); do
              if grep -q "oss-collab\.excalidraw\.com" "$$f" 2>/dev/null; then
                sed -i "s|https://oss-collab\.excalidraw\.com|$$WS_URL|g; s|wss://oss-collab\.excalidraw\.com|$$WS_URL|g" "$$f"
                N=$$(($$N + 1))
              fi
            done
            if [ -f "$$dir/env.json" ]; then
              sed -i "s|\"SOCKET_SERVER_URL\":\"[^\"]*\"|\"SOCKET_SERVER_URL\":\"$$WS_URL\"|g" "$$dir/env.json"
            fi
          fi
        done
        if [ $$N -eq 0 ]; then
          echo "WARNING: no JS files contained oss-collab in standard dirs. Trying /usr and /app..."
          for f in $$(find /usr /app -type f -name "*.js" ! -path "*/node_modules/*" 2>/dev/null); do
            if grep -q "oss-collab\.excalidraw\.com" "$$f" 2>/dev/null; then
              sed -i "s|https://oss-collab\.excalidraw\.com|$$WS_URL|g; s|wss://oss-collab\.excalidraw\.com|$$WS_URL|g" "$$f"
              N=$$(($$N + 1))
              echo "Patched: $$f"
            fi
          done
        fi
        echo "Patched $$N JS file(s). Starting nginx..."
        exec nginx -g 'daemon off;'
    environment:
      SOCKET_SERVER_URL: ${EXCALIDRAW_ROOM_WS_URL:-wss://excalidraw-room.math-nastya.ru}
      STORAGE_BACKEND: "http"
      HTTP_STORAGE_BACKEND_URL: ${EXCALIDRAW_STORAGE_URL:-https://excalidraw-api.math-nastya.ru}/api/v2
      BACKEND_V2_GET_URL: ${EXCALIDRAW_STORAGE_URL:-https://excalidraw-api.math-nastya.ru}/api/v2/scenes/
      BACKEND_V2_POST_URL: ${EXCALIDRAW_STORAGE_URL:-https://excalidraw-api.math-nastya.ru}/api/v2/scenes/
      LIBRARY_URL: https://libraries.excalidraw.com
      LIBRARY_BACKEND: https://us-central1-excalidraw-room-persistence.cloudfunctions.net/libraries
      EXCALIDRAW_ROOM_WS_URL: ${EXCALIDRAW_ROOM_WS_URL:-wss://excalidraw-room.math-nastya.ru}

  excalidraw-room-backend:
    image: excalidraw/excalidraw-room:latest
    container_name: excalidraw-room-backend
    restart: unless-stopped

  excalidraw-room:
    image: nginx:alpine
    container_name: excalidraw-room-proxy
    restart: unless-stopped
    volumes:
      - ./excalidraw-room-proxy.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - excalidraw-room-backend

  excalidraw-storage-backend:
    image: kiliandeca/excalidraw-storage-backend:latest
    container_name: excalidraw-storage
    restart: unless-stopped
    environment:
      STORAGE_URI: redis://redis:6379
      PORT: "8080"
      GLOBAL_PREFIX: /api/v2

  redis:
    image: redis:7-alpine
    container_name: excalidraw-redis
    restart: unless-stopped
