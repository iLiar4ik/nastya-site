# Полный стек Excalidraw со сборкой фронтенда из официального репозитория (актуальный UI, без sed/SW-заглушки).
# В Dokploy укажите путь к compose: deploy/excalidraw/docker-compose.official.yml
# Environment: EXCALIDRAW_ROOM_WS_URL=wss://excalidraw-room.ваш-домен.ru, EXCALIDRAW_STORAGE_URL=https://excalidraw-api.ваш-домен.ru
# Первая сборка: клон GitHub + yarn build (~5–10 мин).

services:
  excalidraw:
    build:
      context: .
      dockerfile: Dockerfile.official
      args:
        EXCALIDRAW_ROOM_WS_URL: ${EXCALIDRAW_ROOM_WS_URL:-wss://excalidraw-room.math-nastya.ru}
        EXCALIDRAW_STORAGE_URL: ${EXCALIDRAW_STORAGE_URL:-https://excalidraw-api.math-nastya.ru}
    image: excalidraw-frontend:official
    container_name: excalidraw-frontend
    restart: unless-stopped

  excalidraw-room-backend:
    image: excalidraw/excalidraw-room:latest
    container_name: excalidraw-room-backend
    restart: unless-stopped

  excalidraw-room:
    image: nginx:alpine
    container_name: excalidraw-room-proxy
    restart: unless-stopped
    volumes:
      - ./excalidraw-room-proxy.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - excalidraw-room-backend

  excalidraw-storage-backend:
    image: kiliandeca/excalidraw-storage-backend:latest
    container_name: excalidraw-storage
    restart: unless-stopped
    environment:
      STORAGE_URI: redis://redis:6379
      PORT: "8080"
      GLOBAL_PREFIX: /api/v2

  redis:
    image: redis:7-alpine
    container_name: excalidraw-redis
    restart: unless-stopped
