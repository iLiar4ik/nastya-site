# Почему пропадала доска tldraw — анализ

## Симптомы

- Доска появляется, несколько секунд работает, затем **полностью исчезает** (и канвас, и надпись «Загружено в …»).
- То же самое в отдельной вкладке `/lesson/board` и в iframe на странице урока.
- Ошибок в консоли пользователь не видел.

## Вывод анализа

Единственный код в проекте, который делает **автоматическую перезагрузку страницы** по таймеру — **`app/chunk-error-handler.tsx`**.

- Он вешает глобальные обработчики: `window.addEventListener("error", ...)`, `window.addEventListener("unhandledrejection", ...)`, `window.onerror`.
- При сообщении, содержащем слово **"chunk"** (или при «ChunkLoadError»), через **1 секунду** вызывался **`window.location.reload()`**.
- tldraw подгружается через **dynamic import** (чанки Next.js). Любая ошибка или предупреждение из загрузки/работы чанка (в т.ч. из iframe доски) могла попадать в эти обработчики и вызывать reload.
- В iframe документ имеет `pathname === "/lesson/board"`, в родителе — `pathname === "/lesson/room/..."`. Даже после добавления проверки `pathname.startsWith("/lesson/")` перезагрузка могла срабатывать в edge-cases (другой порядок событий, другой контекст ошибки), поэтому доска всё равно пропадала.

То есть **причина пропадания доски — перезагрузка страницы**, которую инициировал ChunkErrorHandler при срабатывании на ошибках, связанных с чанками/tldraw.

## Что сделано

1. **ChunkErrorHandler** — сначала отключён `reload()`, затем **полностью убран из `app/layout.tsx`**, чтобы не загружался на страницах (исключаем влияние и старый кэш сборки).
2. **LessonRoomClient** — раз показываем комнату (`useLiveKit === true`), не переключаем обратно на «Комната недоступна» при повторном запросе токена.

3. **Доска без iframe** — если пропадал только tldraw (комната остаётся), причина была в отдельном документе iframe (свой layout, свои скрипты). Доска снова встроена **прямо в страницу комнаты урока** (компонент `TldrawBoard` в `LiveKitLessonRoom`). Один документ — отдельно «перезагрузить» только доску нельзя.

4. **Отдельный React-корень для доски** — tldraw рендерится через `createRoot(container)` в `useEffect` внутри `TldrawBoard`, а не как дочерний компонент основного дерева. Так ре-рендеры родителя (LiveKit, состояние комнаты) не могут размонтировать доску из-за reconciliation.

5. **Диагностика** — в углу доски показывается блок «Доска активна · HH:MM:SS» с обновлением раз в секунду. Если после исчезновения канваса этот блок **остаётся и время идёт** — контейнер не размонтирован, проблема внутри tldraw. Если **пропадает вместе с доской** — размонтируется весь блок (родитель).

## Что проверялось и не является причиной

- **LessonRoomClient / useLiveKit** — эффект запроса токена зависит только от `[mounted, studentId]`; повторного запроса через несколько секунд без смены студента нет, переключения на «Комната недоступна» из-за этого не происходит.
- **LiveKitLessonRoom / tokenData** — токен запрашивается один раз, условие `!tokenData` не меняется через несколько секунд.
- **Редиректы** — на страницах `/lesson/board` и `/lesson/room/[studentId]` нет кода, делающего redirect или `window.location` через несколько секунд.
- **router.refresh()** — вызывается только в AdminLogin и auth, не на уроке.
- **Middleware** — в проекте нет middleware.
- **React Strict Mode** — отключён; в production двойного монтирования всё равно нет, так что это не объясняет пропадание на деплое.

## Рекомендация

После деплоя проверить: если доска стабильна — оставить ChunkErrorHandler без reload. При необходимости восстановить авто-перезагрузку только для явных ChunkLoadError и только на маршрутах, где нет доски (например, исключать все `/lesson/*` и вызывать reload только если `pathname.startsWith("/lesson/") === false`).
